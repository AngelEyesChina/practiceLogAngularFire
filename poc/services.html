<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular-resource.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular-route.min.js"></script>
    <script src="//cdn.firebase.com/js/client/1.0.21/firebase.js"></script>
    <script src="//cdn.firebase.com/libs/angularfire/0.8.2/angularfire.min.js"></script>

    <script type="text/javascript">
        angular.module('userApp', ['ngRoute', 'firebase'])

        .value('fbURL', 'https://glowing-inferno-4287.firebaseio.com/users/')

        .config(function($routeProvider) {
            $routeProvider
                .when('/', {
                    controller: 'ListCtrl',
                    templateUrl: 'list.html'
                })
                .when('/edit/:userId', {
                    controller: 'EditCtrl',
                    templateUrl: 'detail.html'
                })
                .when('/new', {
                    controller: 'CreateCtrl',
                    templateUrl: 'detail.html'
                })
                .otherwise({
                    redirectTo: '/'
                });
        })

        .controller('ListCtrl', function($scope, Users) {
            $scope.users = Users.getAll();
        })

        .controller('CreateCtrl', function($scope, $location, $timeout, Users) {
            $scope.save = function() {
                Users.$add($scope.user, function() {
                    $timeout(function() {
                        $location.path('/');
                    });
                });
            };
        })

        .factory("User", function($firebase, $FirebaseArray) {
            function User(snap) {
                this.$id = snap.name();
                this.user = snap.val();
            }
            User.prototype = {
                update: function(snap) {
                    this.user = snap.val();
                },
                toJSON: function() {
                    return this.user;
                },
                mylists: function() {
                    return this.user.lists.$asArray();
                }
            };

            return User;
        })

        .factory("UserFactory", function($FirebaseArray, User) {
            return $FirebaseArray.$extendFactory({
                // override the $createObject behavior to return a User object
                $createObject: function(snap) {
                    return new User(snap);
                },

                // override the $$updated behavior to call a method on the User
                $$updated: function(snap) {
                    var i = this.$indexFor(snap.name());
                    var user = this._list[i];
                    user.update(snap);
                }
            });
        })

        .factory("Users", function($firebase, fbURL, UserFactory) {
            var ref = new Firebase(fbURL);

            return {
                getAll: function() {
                    return $firebase(ref, {
                        arrayFactory: UserFactory
                    }).$asArray();
                },
                getById: function(id) {
                    // TODO: Implement object factory
                    return $firebase(ref.child(id), {
                        arrayFactory: UserFactory
                    }).$asArray();
                }
            };
        })

        .controller('EditCtrl', function($scope, $location, $routeParams, $firebase, fbURL, Users) {

            $scope.user = Users.getById($routeParams.userId).$loaded().then(function() {
                console.log(arguments);
            }).catch(function() {
                console.log(arguments);
            });

            $scope.destroy = function() {
                $scope.user.$remove();
                $location.path('/');
            };

            $scope.save = function() {
                $scope.user.$save();
                $location.path('/');
            };
        });
    </script>
</head>

<body>
    <h1>Hello Plunker!</h1>
    <div ng-app="userApp">
        <h2>Users</h2>
        <div ng-view></div>


        <!-- CACHE FILE: list.html -->
        <script type="text/ng-template" id="list.html">
            <input type="text" ng-model="search" class="search-query" placeholder="Search">
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Description</th>
                        <th><a href="#/new"><i class="glyphicon glyphicon-plus-sign"></i></a>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="user in users | filter:search | orderBy:'name'">
                        <td><a href="{{user.site}}" target="_blank">{{user.name}}</a>
                        </td>
                        <td>{{user.description}}</td>
                        <td>
                            <a href="#/edit/{{user.$id}}">Edit</a>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div ng-repeat="user in users">
                {{user.lists}}
            </div>
            <div ng-repeat="user in users">
                <div ng-repeat="list in user.mylists">
                    {{list.$id}}
                </div>
            </div>
        </script>

        <!-- CACHE FILE: detail.html -->
        <script type="text/ng-template" id="detail.html">
            <form name="myForm">
                <div class="control-group" ng-class="{error: myForm.name.$invalid && !myForm.name.$pristine}">
                    <label>Name</label>
                    <input type="text" name="name" ng-model="user.name" required>
                    <span ng-show="myForm.name.$error.required && !myForm.name.$pristine" class="help-inline">
            Required {{myForm.name.$pristine}}</span>
                </div>

                <div class="control-group" ng-class="{error: myForm.site.$invalid && !myForm.site.$pristine}">
                    <label>Website</label>
                    <input type="url" name="site" ng-model="user.site" required>
                    <span ng-show="myForm.site.$error.required && !myForm.name.$pristine" class="help-inline">
            Required</span>
                    <span ng-show="myForm.site.$error.url" class="help-inline">
            Not a URL</span>
                </div>

                <label>Description</label>
                <textarea name="description" ng-model="user.description"></textarea>

                <br>
                <a href="#/" class="btn">Cancel</a>
                <button ng-click="save()" ng-disabled="myForm.$invalid" class="btn btn-primary">Save</button>
                <button ng-click="destroy()" ng-show="user.$remove" class="btn btn-danger">Delete</button>
            </form>
        </script>
    </div>

</body>

</html>
